Hamdan:

Q1: Customers Who Spent the Most on Purchases
Code: 
SELECT c.Username, c.First_Name, c.Last_Name, SUM(p.Quantity * i.Price) AS Total_Spent
FROM Purchases_Items p
JOIN Items i ON p.Barcode = i.Barcode
JOIN Customer c ON p.Username = c.Username
GROUP BY c.Username, c.First_Name, c.Last_Name
ORDER BY Total_Spent DESC
LIMIT 10;


Q2:Identify Top 5 Borrowed Books in the Last Year
Code:
SELECT br.Title, COUNT(b.BookID) AS Borrow_Count
FROM Borrows b
JOIN Books_for_Rent br ON b.BookID = br.BookID
WHERE b.Date_Out >= CURRENT_DATE - INTERVAL '1 year'
GROUP BY br.Title
ORDER BY Borrow_Count DESC
LIMIT 5;

Q3: List Customers Who Have Unreturned Books Past Due Date
Code:
SELECT c.Username, c.First_Name, c.Last_Name, b.BookID, br.Title, b.Due_Date, 
       (CURRENT_DATE - b.Due_Date) * 0.5 AS Fine_Amount
FROM Borrows b
JOIN Customer c ON b.Username = c.Username
JOIN Books_for_Rent br ON b.BookID = br.BookID
WHERE b.Due_Date < CURRENT_DATE AND b.Penalty = 0;

Q4: Analyze Revenue from Book Sales in a Specific Branch
Code:
SELECT lb.BranchID, SUM(bb.Quantity * bs.Price) AS Total_Revenue
FROM Buys_Books bb
JOIN Books_for_Sale bs ON bb.ISBN = bs.ISBN
JOIN Libraryy lb ON bb.BranchID = lb.BranchID
WHERE lb.BranchID = 'LIBTECH01'
GROUP BY lb.BranchID;

Q5: Find Books Moved from Sale to Rent with Discounts Over 50%
Code:
SELECT st.BookID, st.ISBN, st.Date_Moved, st.Discount, br.Title
FROM Sale_to_Rent st
JOIN Books_for_Rent br ON st.BookID = br.BookID
WHERE st.Discount > 50;

Q6: Determine Stock Levels of Items in All Branches
Code:
SELECT si.BranchID, i.Items_Name, SUM(si.Qty_Stored) AS Total_Stock
FROM Stores_Items si
JOIN Items i ON si.Barcode = i.Barcode
GROUP BY si.BranchID, i.Items_Name
ORDER BY Total_Stock ASC;

Q7: Check Which Authors Have Published the Most Books
Code:
SELECT ab.Author_Name, COUNT(ab.ISBN) AS Published_Books
FROM Authors_BookSale ab
GROUP BY ab.Author_Name
ORDER BY Published_Books DESC;

Q8: Branch with the Highest Number of Rentals
Code: 
SELECT b.BranchID, COUNT(br.BookID) AS Rentals_Count
FROM Borrows br
JOIN Books_for_Rent b ON br.BookID = b.BookID
GROUP BY b.BranchID
ORDER BY Rentals_Count DESC
LIMIT 1;

Q9: Monthly Breakdown of Supplier Deliveries
Code: 
SELECT TO_CHAR(i.Date_Supplied, 'YYYY-MM') AS Supply_Month, s.Supp_Name, 
       SUM(i.Qty_Supplied) AS Total_Delivered
FROM Items i
JOIN Supplier s ON i.Supp_Name = s.Supp_Name
GROUP BY TO_CHAR(i.Date_Supplied, 'YYYY-MM'), s.Supp_Name
ORDER BY Supply_Month DESC;

Q10:Books and Items Frequently Bought Together
Code: 
SELECT bb.ISBN, i.Barcode, COUNT(*) AS Frequency
FROM Buys_Books bb
JOIN Purchases_Items pi ON bb.Username = pi.Username
WHERE bb.Date_Time::date = pi.Date_Time::date
GROUP BY bb.ISBN, i.Barcode
ORDER BY Frequency DESC;



Tia: 

Q1: Retrieve the total amount each customer has spent on book purchases and item purchases and the most frequently visited branch.
Code:
SELECT 
    c.Username,
    c.First_Name,
    c.Last_Name,
    COALESCE(SUM(b.Quantity * bs.Price), 0) AS Total_Book_Spending,
    COALESCE(SUM(i.Quantity * it.Price), 0) AS Total_Item_Spending,
    (SELECT BranchID 
     FROM Buys_Books b2 
     WHERE b2.Username = c.Username 
     GROUP BY BranchID 
     ORDER BY COUNT(*) DESC 
     LIMIT 1) AS Favorite_Branch
FROM 
    Customer c
LEFT JOIN Buys_Books b ON c.Username = b.Username
LEFT JOIN Books_for_Sale bs ON b.ISBN = bs.ISBN
LEFT JOIN Purchases_Items i ON c.Username = i.Username
LEFT JOIN Items it ON i.Barcode = it.Barcode
GROUP BY 
    c.Username, c.First_Name, c.Last_Name;


Q2: List staff who have worked more than 10% above the average hours across all branches.
Code:
SELECT 
    First_Name, 
    Last_Name, 
    Hours
FROM 
    Staff
WHERE 
    Hours > (SELECT AVG(Hours) FROM Staff) * 1.1;


Q3: Categorize customers into segments (High, Medium, Low spenders) based on their total spending
Code:
WITH Customer_Spend AS ( 
    SELECT 
        c.Username, 
        COALESCE(SUM(b.Quantity * bs.Price), 0) + COALESCE(SUM(i.Quantity * it.Price), 0) AS Total_Spending
    FROM 
        Customer c
    LEFT JOIN Buys_Books b ON c.Username = b.Username
    LEFT JOIN Books_for_Sale bs ON b.ISBN = bs.ISBN
    LEFT JOIN Purchases_Items i ON c.Username = i.Username
    LEFT JOIN Items it ON i.Barcode = it.Barcode
    GROUP BY c.Username
)
SELECT 
    Username, 
    CASE 
        WHEN Total_Spending > 500 THEN 'High Spender'
        WHEN Total_Spending > 200 THEN 'Medium Spender'
        ELSE 'Low Spender'
    END AS Customer_Segment
FROM 
    Customer_Spend;
-- COALESCE Ensures that if either SUM() returns NULL, it defaults to 0 instead, preventing null values from affecting the result.


Q4: Find the top 5 suppliers who generated the most revenue from their items.
Code:
SELECT 
    s.Supp_Name, 
    SUM(i.Price * p.Quantity) AS Total_Revenue
FROM 
    Purchases_Items p
JOIN 
    Items i ON p.Barcode = i.Barcode
JOIN 
    Supplier s ON i.Supp_Name = s.Supp_Name
GROUP BY 
    s.Supp_Name
ORDER BY 
    Total_Revenue DESC
LIMIT 2;










Zak:


Q1:   --List all customers who bought books or items more than once from a single library branch.     
Code:
SELECT c.Username, c.First_Name, c.Last_Name, COUNT(b.ISBN) + COUNT(p.Barcode) AS Total_Purchases, b.BranchID
FROM Customer c
LEFT JOIN Buys_Books b ON c.Username = b.Username
LEFT JOIN Purchases_Items p ON c.Username = p.Username
GROUP BY c.Username, c.First_Name, c.Last_Name, b.BranchID
HAVING COUNT(b.ISBN) + COUNT(p.Barcode) > 1;


Q2:--Retrieve staff who manage libraries with the highest number of items
Code:
SELECT s.First_Name, s.Last_Name, s.BranchID, SUM(si.Qty_Stored) AS Total_Items
FROM Staff s
JOIN Stores_Items si ON s.BranchID = si.BranchID
WHERE s.Post = 'Manager'
GROUP BY s.First_Name, s.Last_Name, s.BranchID
ORDER BY Total_Items DESC
LIMIT 1;

Q3: --Find books that moved from sale to rent and were rented out, including penalties incurred.
Code:
SELECT sr.BookID, bfr.Title, bfr.Genre, bfr.Price, sr.Discount, br.Penalty
FROM Sale_to_Rent sr
JOIN Books_for_Rent bfr ON sr.BookID = bfr.BookID
JOIN Borrows br ON sr.BookID = br.BookID;

Q4: --Get the average penalty by genre for books rented out.
Code:
SELECT bfr.Genre, AVG(br.Penalty) AS Avg_Penalty
FROM Books_for_Rent bfr
JOIN Borrows br ON bfr.BookID = br.BookID
GROUP BY bfr.Genre
ORDER BY Avg_Penalty DESC;

Q5: --Find library branches that are running low on inventory.
Code:
SELECT si.BranchID, l.Address, SUM(si.Qty_Stored) AS Total_Items, SUM(sb.Number_of_Copies) AS Total_Books
FROM Stores_Items si
JOIN Libraryy l ON si.BranchID = l.BranchID
JOIN Stores_booksforsale sb ON si.BranchID = sb.BranchID
GROUP BY si.BranchID, l.Address
HAVING SUM(si.Qty_Stored) + SUM(sb.Number_of_Copies) < 50;


Q6: --Total Revenue from Book and Item Sales by Library Branch
Code:
SELECT 
    l.BranchID,
    COALESCE(SUM(bb.Quantity * bfs.Price), 0) AS Book_Sales_Revenue,
    COALESCE(SUM(pi.Quantity * i.Price), 0) AS Item_Sales_Revenue,
    COALESCE(SUM(bb.Quantity * bfs.Price), 0) + COALESCE(SUM(pi.Quantity * i.Price), 0) AS Total_Revenue
FROM 
    Libraryy l
LEFT JOIN Buys_Books bb ON l.BranchID = bb.BranchID
LEFT JOIN Books_for_Sale bfs ON bb.ISBN = bfs.ISBN
LEFT JOIN Purchases_Items pi ON l.BranchID = pi.BranchID
LEFT JOIN Items i ON pi.Barcode = i.Barcode
GROUP BY l.BranchID
ORDER BY Total_Revenue DESC;

Q7: --List authors who have contributed to both books for sale and books for rent.
Code:
SELECT DISTINCT ab.Author_Name
FROM Authors_booksale ab
JOIN Authors_bookrent abr ON ab.Author_Name = abr.Author_Name;

Q8: --Customers Who Borrowed and Then Bought the Same Book Title
Code:
SELECT DISTINCT 
    bo.Username, 
    bfr.Title, 
    bb.Date_Time AS Purchase_Date, 
    bo.Date_Out AS Borrow_Date
FROM 
    Borrows bo
JOIN Books_for_Rent bfr ON bo.BookID = bfr.BookID
JOIN Buys_Books bb ON bo.Username = bb.Username AND bfr.ISBN = bb.ISBN;


Q9: --Retrieve librarians working the most hours across all branches.
Code:
SELECT s.First_Name, s.Last_Name, s.BranchID, s.Hours
FROM Staff s
WHERE s.Post = 'Librarian'
ORDER BY s.Hours DESC
LIMIT 5;

